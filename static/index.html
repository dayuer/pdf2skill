<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pdf2skill â€” æ™ºèƒ½æ–‡æ¡£è§£æ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, "SF Pro Display", "Inter", sans-serif;
        background: #0a0a0f;
        color: #e4e4e7;
        min-height: 100vh;
        overflow: hidden;
      }

      /* â”€â”€ é¡¶æ  â”€â”€ */
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 20px;
        border-bottom: 1px solid #27272a;
        background: #111114;
        height: 48px;
      }
      .topbar h1 {
        font-size: 20px;
        font-weight: 700;
        background: linear-gradient(135deg, #7c3aed, #06b6d4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .topbar-info {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 13px;
        color: #71717a;
      }
      .tag {
        padding: 2px 10px;
        border-radius: 6px;
        background: #27272a;
        color: #a1a1aa;
        font-size: 12px;
      }
      .tag.active {
        background: rgba(124, 58, 237, 0.2);
        color: #c084fc;
      }

      /* â”€â”€ ä¸»ä½“å¸ƒå±€ â”€â”€ */
      .main {
        display: flex;
        height: calc(100vh - 48px);
      }
      .panel {
        overflow-y: auto;
        padding: 16px;
      }
      .left {
        width: 40%;
        min-width: 280px;
        max-width: 65%;
        display: flex;
        flex-direction: column;
        background: #111114;
      }
      .right {
        flex: 1;
        min-width: 300px;
        display: flex;
        flex-direction: column;
        background: #0d0d12;
      }

      /* â”€â”€ æ‹–æ‹½åˆ†éš”æ¡ â”€â”€ */
      .resizer {
        width: 5px;
        cursor: col-resize;
        background: #1e1e24;
        position: relative;
        transition: background 0.2s;
        flex-shrink: 0;
      }
      .resizer:hover,
      .resizer.active {
        background: #7c3aed;
      }
      .resizer::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 3px;
        height: 32px;
        border-radius: 2px;
        background: repeating-linear-gradient(
          180deg,
          #52525b 0,
          #52525b 4px,
          transparent 4px,
          transparent 8px
        );
      }

      /* â”€â”€ ä¸Šä¼ åŒº â”€â”€ */
      .upload-zone {
        border: 2px dashed #3f3f46;
        border-radius: 12px;
        padding: 60px 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        margin: 40px 16px;
      }
      .upload-zone:hover {
        border-color: #7c3aed;
        background: rgba(124, 58, 237, 0.05);
      }
      .upload-icon {
        font-size: 40px;
        margin-bottom: 12px;
      }
      .upload-text {
        color: #71717a;
        font-size: 14px;
      }
      input[type="file"] {
        display: none;
      }

      /* â”€â”€ æ–‡æ¡£æ‘˜è¦ â”€â”€ */
      .doc-summary {
        padding: 10px 14px;
        background: #18181b;
        border-radius: 8px;
        margin-bottom: 10px;
        font-size: 12px;
        border: 1px solid #27272a;
      }
      .doc-summary .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 4px;
      }
      .doc-summary .label {
        color: #71717a;
      }
      .doc-summary .val {
        color: #e4e4e7;
        font-weight: 500;
      }
      .doc-summary .val.hl {
        color: #c084fc;
      }
      .summary-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 4px;
      }
      .summary-tag {
        padding: 2px 7px;
        border-radius: 4px;
        font-size: 10px;
        background: rgba(124, 58, 237, 0.12);
        color: #c084fc;
      }
      .summary-tag.green {
        background: rgba(34, 197, 94, 0.12);
        color: #4ade80;
      }

      /* â”€â”€ è®¾ç½®è¡Œ â”€â”€ */
      .setting-select {
        flex: 1;
        padding: 5px 8px;
        background: #27272a;
        color: #e4e4e7;
        border: 1px solid #3f3f46;
        border-radius: 6px;
        font-size: 12px;
      }

      /* â”€â”€ Chunk åˆ—è¡¨ â”€â”€ */
      .chunk-header {
        display: flex;
        gap: 6px;
        align-items: center;
        margin-bottom: 6px;
      }
      .chunk-search {
        flex: 1;
        padding: 6px 10px;
        background: #1f1f23;
        color: #e4e4e7;
        border: 1px solid #3f3f46;
        border-radius: 6px;
        font-size: 12px;
      }
      .chunk-count {
        font-size: 11px;
        color: #52525b;
        margin-bottom: 6px;
      }
      .chunk-list {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
      }
      .chunk-item {
        padding: 8px 10px;
        margin-bottom: 3px;
        border-radius: 6px;
        background: #18181b;
        border: 1px solid transparent;
        cursor: pointer;
        font-size: 11px;
        color: #a1a1aa;
        transition: all 0.15s;
        line-height: 1.5;
      }
      .chunk-item:hover {
        border-color: #3f3f46;
        background: #1f1f23;
      }
      .chunk-item.selected {
        border-color: #7c3aed;
        background: rgba(124, 58, 237, 0.08);
        color: #e4e4e7;
      }
      .chunk-item .idx {
        color: #7c3aed;
        font-weight: 600;
        margin-right: 4px;
      }
      .chunk-item .path {
        color: #71717a;
        font-size: 10px;
        display: block;
        margin-top: 2px;
      }

      /* â”€â”€ æŠ˜å è®¾ç½®åŒº â”€â”€ */
      .collapsible-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 0;
        cursor: pointer;
        color: #a1a1aa;
        font-size: 12px;
        font-weight: 500;
        border-top: 1px solid #27272a;
        margin-top: 8px;
        user-select: none;
      }
      .collapsible-header:hover {
        color: #e4e4e7;
      }
      .collapsible-header .arrow {
        transition: transform 0.2s;
        font-size: 10px;
      }
      .collapsible-header .arrow.open {
        transform: rotate(90deg);
      }
      .collapsible-body {
        overflow: hidden;
        max-height: 0;
        transition: max-height 0.3s ease;
      }
      .collapsible-body.open {
        max-height: 600px;
      }

      .prompt-textarea {
        width: 100%;
        min-height: 80px;
        padding: 8px 10px;
        background: #1f1f23;
        color: #e4e4e7;
        border: 1px solid #3f3f46;
        border-radius: 6px;
        font-size: 11px;
        resize: vertical;
        font-family: inherit;
        line-height: 1.5;
      }
      .prompt-textarea:focus {
        outline: none;
        border-color: #7c3aed;
      }
      .prompt-label {
        font-size: 11px;
        color: #71717a;
        margin: 6px 0 4px;
      }

      /* â”€â”€ åº•éƒ¨æ“ä½œæ  â”€â”€ */
      .action-bar {
        display: flex;
        gap: 8px;
        padding: 10px 0 4px;
        border-top: 1px solid #27272a;
        margin-top: auto;
        flex-shrink: 0;
        flex-wrap: wrap;
      }

      /* â”€â”€ æŒ‰é’® â”€â”€ */
      .btn {
        padding: 7px 16px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
      }
      .btn-primary {
        background: #7c3aed;
        color: #fff;
      }
      .btn-primary:hover {
        background: #6d28d9;
      }
      .btn-ghost {
        background: transparent;
        color: #a1a1aa;
        border: 1px solid #3f3f46;
      }
      .btn-ghost:hover {
        border-color: #7c3aed;
        color: #c084fc;
      }
      .btn-sm {
        padding: 4px 10px;
        font-size: 11px;
      }
      .btn-success {
        background: #166534;
        color: #4ade80;
      }
      .btn-warn {
        background: #7c2d12;
        color: #fb923c;
      }

      /* â”€â”€ å³æ åŒºåŸŸ â”€â”€ */
      .right-section {
        padding: 12px 16px;
      }
      .section-title {
        font-size: 12px;
        color: #71717a;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
      }

      .source-preview {
        background: #111114;
        padding: 12px;
        border-radius: 8px;
        font-size: 12px;
        color: #a1a1aa;
        white-space: pre-wrap;
        max-height: 280px;
        overflow-y: auto;
        border: 1px solid #27272a;
        line-height: 1.6;
      }

      .result-pane {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
      }
      .skill-card {
        padding: 10px;
        margin-bottom: 6px;
        border-radius: 8px;
        background: #1a1a20;
        border-left: 3px solid #22c55e;
      }
      .skill-card.fail {
        border-left-color: #ef4444;
      }
      .skill-name {
        font-weight: 600;
        font-size: 13px;
        color: #f4f4f5;
        margin-bottom: 3px;
      }
      .skill-trigger {
        font-size: 11px;
        color: #a1a1aa;
        margin-bottom: 4px;
      }
      .skill-domain {
        padding: 2px 7px;
        border-radius: 4px;
        font-size: 10px;
        background: rgba(124, 58, 237, 0.12);
        color: #c084fc;
      }
      .skill-body {
        margin-top: 6px;
        font-size: 11px;
        color: #a1a1aa;
        white-space: pre-wrap;
        max-height: 100px;
        overflow-y: auto;
      }

      /* â”€â”€ ç‰ˆæœ¬æ—¶é—´çº¿ â”€â”€ */
      .version-timeline {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .version-dot {
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 10px;
        background: #27272a;
        color: #a1a1aa;
        cursor: pointer;
        transition: all 0.2s;
      }
      .version-dot:hover {
        background: rgba(124, 58, 237, 0.2);
        color: #c084fc;
      }
      .version-dot.active {
        background: #7c3aed;
        color: #fff;
      }

      /* â”€â”€ è¿›åº¦æ¡ â”€â”€ */
      .progress-bar {
        height: 5px;
        background: #27272a;
        border-radius: 3px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #7c3aed, #06b6d4);
        width: 0;
        transition: width 0.3s;
      }
      .progress-text {
        font-size: 11px;
        color: #71717a;
        margin-top: 4px;
      }

      /* â”€â”€ åŠ è½½ â”€â”€ */
      .spinner {
        width: 14px;
        height: 14px;
        border: 2px solid #3f3f46;
        border-top-color: #7c3aed;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .loading-text {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #71717a;
        font-size: 12px;
        padding: 10px;
      }

      /* â”€â”€ æŠ½æ ·éªŒè¯ â”€â”€ */
      .sample-card {
        padding: 8px;
        margin-bottom: 4px;
        border-radius: 6px;
        background: #1f1f23;
        border: 1px solid #27272a;
        font-size: 11px;
      }
      .sample-pass {
        color: #4ade80;
      }
      .sample-fail {
        color: #f87171;
      }

      /* â”€â”€ å³æ å ä½ â”€â”€ */
      .right-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #3f3f46;
        font-size: 14px;
      }

      /* â”€â”€ æ»šåŠ¨æ¡ç¾åŒ– â”€â”€ */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #27272a;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #3f3f46;
      }
    </style>
  </head>
  <body>
    <!-- é¡¶æ  -->
    <div class="topbar">
      <div style="display: flex; align-items: center; gap: 12px">
        <h1>pdf2skill</h1>
        <span
          id="doc-name-display"
          style="font-size: 12px; color: #71717a"
        ></span>
      </div>
      <div class="topbar-info">
        <span id="strategy-tag" class="tag" style="display: none"></span>
        <span id="chunk-count-tag" class="tag" style="display: none"></span>
        <button
          class="btn btn-ghost btn-sm"
          onclick="resetSession()"
          style="display: none"
          id="btn-reupload"
        >
          ğŸ“„ é‡æ–°ä¸Šä¼ 
        </button>
      </div>
    </div>

    <div class="main">
      <!-- â•â•â•â•â•â•â• å·¦æ ï¼šæ“ä½œä¸­å¿ƒ â•â•â•â•â•â•â• -->
      <div class="left panel" id="left-panel">
        <!-- ä¸Šä¼ åŒºï¼ˆåˆå§‹é¡µï¼‰ -->
        <div id="upload-area">
          <div
            class="upload-zone"
            id="dropzone"
            onclick="document.getElementById('fileInput').click()"
          >
            <div class="upload-icon">ğŸ“„</div>
            <div class="upload-text">
              æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©<br />æ”¯æŒ PDF / TXT / EPUB / MD
            </div>
          </div>
          <input type="file" id="fileInput" accept=".pdf,.txt,.epub,.md" />
        </div>
        <div id="analysis-loading" style="display: none" class="loading-text">
          <div class="spinner"></div>
          <span>æ­£åœ¨åˆ†ææ–‡æ¡£ç±»å‹å’ŒçŸ¥è¯†ç»“æ„...</span>
        </div>

        <!-- æ–‡æ¡£ä¿¡æ¯ -->
        <div id="doc-summary" style="display: none"></div>

        <!-- Chunk åˆ—è¡¨ -->
        <div
          id="chunk-panel"
          style="display: none; flex-direction: column; min-height: 0; flex: 1"
        >
          <div class="chunk-header">
            <input
              id="chunk-search"
              class="chunk-search"
              placeholder="æœç´¢ chunkâ€¦"
              oninput="searchChunks()"
            />
            <button
              class="btn btn-ghost btn-sm"
              onclick="rechunkDoc()"
              style="white-space: nowrap; font-size: 10px"
            >
              ğŸ”„ é‡åˆ‡
            </button>
          </div>
          <div id="chunk-count" class="chunk-count"></div>
          <div id="chunk-list" class="chunk-list"></div>
        </div>

        <!-- æŠ˜å è®¾ç½®åŒº -->
        <div id="settings-area" style="display: none">
          <div class="collapsible-header" onclick="toggleSettings()">
            <span>âš™ï¸ æå–è®¾ç½®</span>
            <span class="arrow" id="settings-arrow">â–¶</span>
          </div>
          <div class="collapsible-body" id="settings-body">
            <div class="prompt-label">
              ç³»ç»Ÿ Prompt
              <button
                class="btn btn-ghost btn-sm"
                onclick="saveSystemPrompt()"
                style="float: right; padding: 2px 8px; font-size: 10px"
              >
                ğŸ’¾ ä¿å­˜
              </button>
            </div>
            <textarea
              id="system-prompt-display"
              class="prompt-textarea"
              style="min-height: 100px"
            ></textarea>
            <div class="prompt-label">æå–ç­–ç•¥</div>
            <textarea
              id="prompt-hint"
              class="prompt-textarea"
              placeholder="åŠ è½½ä¸­..."
            ></textarea>
          </div>
        </div>

        <!-- åº•éƒ¨æ“ä½œæ  -->
        <div class="action-bar" id="action-bar" style="display: none">
          <button class="btn btn-primary" onclick="runTune()">
            ğŸ”¬ æå–å¹¶å¯¹æ¯”
          </button>
          <button class="btn btn-ghost btn-sm" onclick="runSampleCheck()">
            ğŸ² æŠ½æ ·éªŒè¯
          </button>
          <button class="btn btn-ghost btn-sm" onclick="startExecute()">
            âš¡ å…¨é‡æ‰§è¡Œ
          </button>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â• æ‹–æ‹½åˆ†éš”æ¡ â•â•â•â•â•â•â• -->
      <div class="resizer" id="resizer"></div>

      <!-- â•â•â•â•â•â•â• å³æ ï¼šå¯¹æ¯”è°ƒæ•´åŒº â•â•â•â•â•â•â• -->
      <div class="right panel" id="right-panel">
        <div id="right-placeholder" class="right-placeholder">
          â† ä¸Šä¼ æ–‡æ¡£åè¿›å…¥æ“ä½œå°
        </div>

        <div
          id="workspace"
          style="display: none; flex-direction: column; min-height: 0; flex: 1"
        >
          <!-- åŠ è½½çŠ¶æ€ -->
          <div id="tune-loading" style="display: none" class="loading-text">
            <div class="spinner"></div>
            <span>æ­£åœ¨æå–...</span>
          </div>

          <!-- åŸæ–‡é¢„è§ˆ -->
          <div
            id="source-preview-section"
            class="right-section"
            style="display: none"
          >
            <div class="section-title">
              ğŸ“– åŸæ–‡ Â· chunk #<span id="source-chunk-idx"></span>
            </div>
            <div id="source-preview" class="source-preview"></div>
          </div>

          <!-- æå–ç»“æœ -->
          <div
            id="result-section"
            style="display: none; flex: 1; min-height: 0; padding: 0 16px 12px"
          >
            <div class="section-title">
              ğŸ¯ æå–ç»“æœ
              <span
                id="result-stats"
                style="color: #52525b; font-size: 10px"
              ></span>
            </div>
            <div id="result-cards" class="result-pane"></div>
          </div>

          <!-- æŠ½æ ·éªŒè¯ç»“æœ -->
          <div id="sample-section" class="right-section" style="display: none">
            <div class="section-title">
              ğŸ² æŠ½æ ·éªŒè¯ç»“æœ
              <span id="sample-stats" style="font-size: 10px"></span>
            </div>
            <div id="sample-cards"></div>
          </div>

          <!-- å…¨é‡æ‰§è¡Œè¿›åº¦ -->
          <div id="execute-section" class="right-section" style="display: none">
            <div class="section-title">âš¡ å…¨é‡æ‰§è¡Œ</div>
            <div class="progress-bar">
              <div class="progress-fill" id="pbar"></div>
            </div>
            <div class="progress-text" id="ptext">å‡†å¤‡ä¸­...</div>
            <div id="execute-result" style="margin-top: 8px"></div>
          </div>

          <!-- ç‰ˆæœ¬å†å² -->
          <div id="version-section" class="right-section" style="display: none">
            <div class="section-title">ğŸ• ç‰ˆæœ¬å†å²</div>
            <div id="version-timeline" class="version-timeline"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      /* â•â•â•â•â•â•â• æ‹–æ‹½åˆ†éš”æ¡é€»è¾‘ â•â•â•â•â•â•â• */
      (function () {
        const resizer = document.getElementById("resizer");
        const left = document.getElementById("left-panel");
        const main = document.querySelector(".main");
        let isResizing = false;

        resizer.addEventListener("mousedown", (e) => {
          isResizing = true;
          resizer.classList.add("active");
          document.body.style.cursor = "col-resize";
          document.body.style.userSelect = "none";
          e.preventDefault();
        });

        document.addEventListener("mousemove", (e) => {
          if (!isResizing) return;
          const rect = main.getBoundingClientRect();
          let pct = ((e.clientX - rect.left) / rect.width) * 100;
          pct = Math.max(20, Math.min(70, pct));
          left.style.width = pct + "%";
        });

        document.addEventListener("mouseup", () => {
          if (isResizing) {
            isResizing = false;
            resizer.classList.remove("active");
            document.body.style.cursor = "";
            document.body.style.userSelect = "";
          }
        });
      })();

      /* â•â•â•â•â•â•â• æŠ˜å è®¾ç½® â•â•â•â•â•â•â• */
      function toggleSettings() {
        const body = document.getElementById("settings-body");
        const arrow = document.getElementById("settings-arrow");
        body.classList.toggle("open");
        arrow.classList.toggle("open");
      }

      /* â•â•â•â•â•â•â• çŠ¶æ€ç®¡ç† â•â•â•â•â•â•â• */
      let sessionId = localStorage.getItem("pdf2skill_session");
      let selectedChunkIdx = null;

      function resetSession() {
        localStorage.removeItem("pdf2skill_session");
        location.reload();
      }

      function esc(s) {
        return (s || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      /* â•â•â•â•â•â•â• ä¸Šä¼  â•â•â•â•â•â•â• */
      const fileInput = document.getElementById("fileInput");
      const dropzone = document.getElementById("dropzone");
      dropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropzone.style.borderColor = "#7c3aed";
      });
      dropzone.addEventListener("dragleave", () => {
        dropzone.style.borderColor = "#3f3f46";
      });
      dropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropzone.style.borderColor = "#3f3f46";
        if (e.dataTransfer.files[0]) uploadFile(e.dataTransfer.files[0]);
      });
      fileInput.addEventListener("change", () => {
        if (fileInput.files[0]) uploadFile(fileInput.files[0]);
      });

      async function uploadFile(file) {
        document.getElementById("upload-area").style.display = "none";
        document.getElementById("analysis-loading").style.display = "flex";
        const fd = new FormData();
        fd.append("file", file);
        try {
          const r = await fetch("/api/analyze", { method: "POST", body: fd });
          const data = await r.json();
          if (!r.ok) {
            alert(data.detail || "åˆ†æå¤±è´¥");
            location.reload();
            return;
          }
          sessionId = data.session_id;
          localStorage.setItem("pdf2skill_session", sessionId);
          showWorkspace(data);
        } catch (e) {
          alert("ä¸Šä¼ å¤±è´¥: " + e.message);
          location.reload();
        }
      }

      /* â•â•â•â•â•â•â• å±•ç¤ºå·¥ä½œåŒº â•â•â•â•â•â•â• */
      function showWorkspace(data) {
        document.getElementById("analysis-loading").style.display = "none";
        document.getElementById("upload-area").style.display = "none";
        document.getElementById("right-placeholder").style.display = "none";
        document.getElementById("workspace").style.display = "flex";
        document.getElementById("settings-area").style.display = "block";
        document.getElementById("action-bar").style.display = "flex";
        document.getElementById("btn-reupload").style.display = "";
        document.getElementById("doc-name-display").textContent =
          "ã€Š" + data.doc_name + "ã€‹";
        document.getElementById("strategy-tag").style.display = "";
        document.getElementById("strategy-tag").textContent = data.prompt_type;
        document.getElementById("chunk-count-tag").style.display = "";
        document.getElementById("chunk-count-tag").textContent =
          data.filtered_chunks + " chunks";

        // æ–‡æ¡£æ‘˜è¦
        const cc = (data.core_components || [])
          .map((c) => '<span class="summary-tag">' + c + "</span>")
          .join("");
        const st = (data.skill_types || [])
          .map((c) => '<span class="summary-tag green">' + c + "</span>")
          .join("");
        const allTypes = [
          "æŠ€æœ¯æ‰‹å†Œ",
          "å™äº‹ç±»",
          "æ–¹æ³•è®º",
          "å­¦æœ¯æ•™æ",
          "æ“ä½œè§„èŒƒ",
          "ä¿é™©åˆåŒ",
          "è¡Œä¸šæŠ¥å‘Š",
          "åŒ»å­¦æ³•å¾‹",
        ];
        if (data.book_type && !allTypes.includes(data.book_type))
          allTypes.push(data.book_type);
        const typeOpts = allTypes
          .map(
            (t) =>
              "<option" +
              (t === data.book_type ? " selected" : "") +
              ">" +
              t +
              "</option>",
          )
          .join("");
        const ds = document.getElementById("doc-summary");
        ds.style.display = "block";
        ds.innerHTML =
          '<div class="doc-summary">' +
          '<div class="row"><span class="label">æ ¼å¼</span><span class="val">' +
          data.format.toUpperCase() +
          "</span>" +
          '<span class="label">é¢†åŸŸ</span><span class="val">' +
          (data.domains || []).join(", ") +
          "</span>" +
          '<span class="label">å—æ•°</span><span class="val">' +
          data.filtered_chunks +
          " / " +
          data.total_chunks +
          "</span></div>" +
          (cc || st ? '<div class="summary-tags">' + cc + st + "</div>" : "") +
          '<div style="margin-top:6px"><select id="sel-book-type" class="setting-select" onchange="autoPromptType();saveSettings()">' +
          typeOpts +
          "</select></div></div>";

        if (data.baseline_hint)
          document.getElementById("prompt-hint").value = data.baseline_hint;
        if (data.system_prompt)
          document.getElementById("system-prompt-display").value =
            data.system_prompt;

        document.getElementById("chunk-panel").style.display = "flex";
        loadChunkList();
      }

      function autoPromptType() {}

      async function saveSettings() {
        if (!sessionId) return;
        await fetch("/api/session/" + sessionId + "/settings", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            book_type: document.getElementById("sel-book-type")?.value || "",
          }),
        });
        try {
          const r = await fetch("/api/prompt-preview/" + sessionId);
          const pp = await r.json();
          if (pp.system_prompt)
            document.getElementById("system-prompt-display").value =
              pp.system_prompt;
          if (pp.baseline_hint)
            document.getElementById("prompt-hint").value = pp.baseline_hint;
        } catch (e) {}
      }

      async function saveSystemPrompt() {
        if (!sessionId) return;
        const sp = document
          .getElementById("system-prompt-display")
          .value.trim();
        await fetch("/api/session/" + sessionId + "/settings", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ system_prompt: sp }),
        });
        const btn = event.target;
        btn.textContent = "âœ… å·²ä¿å­˜";
        setTimeout(() => {
          btn.textContent = "ğŸ’¾ ä¿å­˜";
        }, 1500);
      }

      /* â•â•â•â•â•â•â• Chunk åˆ—è¡¨ â•â•â•â•â•â•â• */
      let _searchTimer = null;
      async function rechunkDoc() {
        if (!sessionId) return;
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = "â³â€¦";
        try {
          const r = await fetch("/api/rechunk/" + sessionId, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ max_chars: 2000, min_chars: 200 }),
          });
          const d = await r.json();
          if (d.ok) {
            btn.textContent = "âœ… " + d.filtered_chunks + "å—";
            setTimeout(() => {
              btn.textContent = "ğŸ”„ é‡åˆ‡";
              btn.disabled = false;
            }, 1500);
            loadChunkList();
          } else {
            btn.textContent = "âŒ";
            btn.disabled = false;
          }
        } catch (e) {
          btn.textContent = "âŒ";
          btn.disabled = false;
        }
      }

      async function loadChunkList(q) {
        try {
          const params = q
            ? "?q=" + encodeURIComponent(q) + "&page_size=50"
            : "?page_size=50";
          const r = await fetch("/api/chunks/" + sessionId + params);
          const data = await r.json();
          document.getElementById("chunk-count").textContent =
            "å…± " + data.total + " å—" + (q ? "ï¼ˆç­›é€‰ï¼‰" : "");
          document.getElementById("chunk-list").innerHTML = data.items
            .map(
              (c) =>
                '<div class="chunk-item' +
                (c.index === selectedChunkIdx ? " selected" : "") +
                '" onclick="selectChunk(' +
                c.index +
                ')" data-idx="' +
                c.index +
                '">' +
                '<span class="idx">#' +
                c.index +
                "</span>" +
                esc(c.preview) +
                '<span class="path">' +
                (c.heading_path.join(" > ") || "") +
                "</span>" +
                "</div>",
            )
            .join("");
        } catch (e) {}
      }

      function searchChunks() {
        clearTimeout(_searchTimer);
        _searchTimer = setTimeout(() => {
          loadChunkList(
            document.getElementById("chunk-search").value.trim() || undefined,
          );
        }, 300);
      }

      function selectChunk(idx) {
        selectedChunkIdx = idx;
        document.querySelectorAll(".chunk-item").forEach((el) => {
          el.classList.toggle("selected", parseInt(el.dataset.idx) === idx);
        });
      }

      /* â•â•â•â•â•â•â• è°ƒä¼˜ â•â•â•â•â•â•â• */
      async function runTune() {
        if (selectedChunkIdx === null) {
          alert("è¯·å…ˆåœ¨å·¦æ é€‰æ‹©ä¸€ä¸ª chunk");
          return;
        }
        const hint = document.getElementById("prompt-hint").value.trim();
        document.getElementById("tune-loading").style.display = "flex";
        document.getElementById("result-section").style.display = "none";
        document.getElementById("source-preview-section").style.display =
          "none";
        try {
          const r = await fetch("/api/tune/" + sessionId, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              chunk_index: selectedChunkIdx,
              prompt_hint: hint,
              system_prompt: document
                .getElementById("system-prompt-display")
                .value.trim(),
            }),
          });
          const d = await r.json();
          showTuneResult(d);
          loadTuneHistory();
        } catch (e) {
          alert("è°ƒä¼˜å¤±è´¥: " + e.message);
        }
        document.getElementById("tune-loading").style.display = "none";
      }

      function showTuneResult(d) {
        document.getElementById("source-preview-section").style.display =
          "block";
        document.getElementById("source-chunk-idx").textContent = d.chunk_index;
        document.getElementById("source-preview").textContent =
          d.source_text || "";

        const sec = document.getElementById("result-section");
        sec.style.display = "flex";
        const skills = d.extracted_skills || [];
        const passed = skills.filter((s) => s.status !== "failed").length;
        document.getElementById("result-stats").textContent =
          "v" +
          (d.version || "?") +
          " Â· " +
          passed +
          "âœ… " +
          (skills.length - passed) +
          "âŒ";
        document.getElementById("result-cards").innerHTML =
          skills
            .map(
              (s) =>
                '<div class="skill-card' +
                (s.status === "failed" ? " fail" : "") +
                '">' +
                '<div class="skill-name">' +
                esc(s.name || "(unnamed)") +
                "</div>" +
                '<div class="skill-trigger">' +
                esc(s.trigger || "") +
                "</div>" +
                '<span class="skill-domain">' +
                esc(s.domain || "general") +
                "</span>" +
                '<div class="skill-body">' +
                esc(s.body || "") +
                "</div>" +
                "</div>",
            )
            .join("") ||
          '<div style="color:#52525b;padding:20px;text-align:center">EMPTY_BLOCK â€” æ— å¯æå–å†…å®¹</div>';
      }

      /* â•â•â•â•â•â•â• ç‰ˆæœ¬å†å² â•â•â•â•â•â•â• */
      async function loadTuneHistory() {
        try {
          const r = await fetch("/api/tune-history/" + sessionId);
          const history = await r.json();
          if (!history.length) return;
          document.getElementById("version-section").style.display = "block";
          document.getElementById("version-timeline").innerHTML = history
            .map(
              (h, i) =>
                '<div class="version-dot' +
                (i === history.length - 1 ? " active" : "") +
                '" onclick="replayVersion(' +
                i +
                ')" title="chunk#' +
                h.chunk_index +
                " " +
                h.timestamp +
                '">' +
                "v" +
                h.version +
                "</div>",
            )
            .join("");
          window._tuneHistory = history;
        } catch (e) {}
      }

      function replayVersion(idx) {
        const h = window._tuneHistory[idx];
        if (!h) return;
        document.getElementById("prompt-hint").value = h.prompt_hint || "";
        selectedChunkIdx = h.chunk_index;
        document.querySelectorAll(".chunk-item").forEach((el) => {
          el.classList.toggle(
            "selected",
            parseInt(el.dataset.idx) === h.chunk_index,
          );
        });
        showTuneResult({
          chunk_index: h.chunk_index,
          source_text: h.source_text_preview || "",
          extracted_skills: h.extracted_skills || [],
          version: h.version,
        });
        document
          .querySelectorAll(".version-dot")
          .forEach((el, i) => el.classList.toggle("active", i === idx));
      }

      /* â•â•â•â•â•â•â• æŠ½æ ·éªŒè¯ â•â•â•â•â•â•â• */
      async function runSampleCheck() {
        document.getElementById("sample-section").style.display = "block";
        document.getElementById("sample-cards").innerHTML =
          '<div class="loading-text"><div class="spinner"></div><span>æ‰¹é‡æå–å’Œæ ¡éªŒä¸­...</span></div>';
        try {
          const r = await fetch("/api/sample-check/" + sessionId, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sample_size: 5 }),
          });
          const d = await r.json();
          const passRate =
            d.total > 0 ? ((d.passed / d.total) * 100).toFixed(0) : 0;
          document.getElementById("sample-stats").innerHTML =
            '<span class="' +
            (passRate >= 60 ? "sample-pass" : "sample-fail") +
            '">é€šè¿‡ç‡ ' +
            passRate +
            "% (" +
            d.passed +
            "/" +
            d.total +
            ")</span>";
          document.getElementById("sample-cards").innerHTML = (d.details || [])
            .map(
              (item) =>
                '<div class="sample-card">' +
                '<div style="display:flex;justify-content:space-between;margin-bottom:3px"><span>#' +
                item.chunk_index +
                "</span>" +
                '<span class="' +
                (item.valid ? "sample-pass" : "sample-fail") +
                '">' +
                (item.valid ? "âœ…" : "âŒ") +
                "</span></div>" +
                '<div style="color:#71717a;font-size:10px">' +
                esc((item.source_preview || "").substring(0, 100)) +
                "</div>" +
                (item.skills || [])
                  .map(
                    (s) =>
                      '<span class="summary-tag" style="margin-top:3px">' +
                      esc(s) +
                      "</span>",
                  )
                  .join("") +
                "</div>",
            )
            .join("");
        } catch (e) {
          document.getElementById("sample-cards").innerHTML =
            '<div style="color:#f87171">éªŒè¯å¤±è´¥: ' + e.message + "</div>";
        }
      }

      /* â•â•â•â•â•â•â• å…¨é‡æ‰§è¡Œ â•â•â•â•â•â•â• */
      function startExecute() {
        if (!confirm("å¼€å§‹å…¨é‡æ‰§è¡Œï¼Ÿå°†ä½¿ç”¨å½“å‰ç­–ç•¥å¤„ç†æ‰€æœ‰ chunkã€‚")) return;
        document.getElementById("execute-section").style.display = "block";
        document.getElementById("pbar").style.width = "0";
        document.getElementById("ptext").textContent = "å‡†å¤‡ä¸­...";
        document.getElementById("execute-result").innerHTML = "";

        const src = new EventSource("/api/execute/" + sessionId);
        src.addEventListener("phase", (e) => {
          const d = JSON.parse(e.data);
          document.getElementById("ptext").textContent = d.message;
          if (d.done && d.total)
            document.getElementById("pbar").style.width =
              (d.done / d.total) * 100 + "%";
        });
        src.addEventListener("progress", (e) => {
          const d = JSON.parse(e.data);
          const pct = ((d.completed / d.total) * 100).toFixed(0);
          document.getElementById("pbar").style.width = pct + "%";
          const eta =
            d.eta_s > 60
              ? (d.eta_s / 60).toFixed(0) + "m"
              : d.eta_s.toFixed(0) + "s";
          document.getElementById("ptext").textContent =
            d.completed +
            "/" +
            d.total +
            " (" +
            pct +
            "%) | ğŸ’¾ " +
            (d.skills_on_disk || 0) +
            " Skills | â±" +
            d.elapsed_s.toFixed(0) +
            "s ETA " +
            eta;
        });
        src.addEventListener("complete", (e) => {
          src.close();
          const d = JSON.parse(e.data);
          document.getElementById("pbar").style.width = "100%";
          document.getElementById("ptext").textContent =
            "âœ… å®Œæˆï¼" + d.final_skills + " Skills â†’ " + d.output_dir;
          const typeColors = {
            factual: "#3b82f6",
            procedural: "#22c55e",
            relational: "#f59e0b",
          };
          const skills = (d.skills || [])
            .map(
              (s) =>
                '<div class="skill-card"><div class="skill-name">' +
                esc(s.name) +
                '</div><div class="skill-trigger">' +
                esc(s.trigger) +
                '</div><span class="skill-domain">' +
                esc(s.domain) +
                '</span> <span style="padding:2px 7px;border-radius:4px;font-size:10px;background:' +
                (typeColors[s.sku_type] || "#666") +
                "20;color:" +
                (typeColors[s.sku_type] || "#aaa") +
                '">' +
                esc(s.sku_type || "") +
                '</span><div class="skill-body">' +
                esc(s.body) +
                "</div></div>",
            )
            .join("");
          const skuInfo = d.sku_stats
            ? " | ğŸ“‹" +
              (d.sku_stats.factual || 0) +
              " äº‹å® âš™ï¸" +
              (d.sku_stats.procedural || 0) +
              " ç¨‹åº ğŸ”—" +
              (d.sku_stats.relational || 0) +
              " å…³ç³»"
            : "";
          document.getElementById("execute-result").innerHTML =
            '<div style="margin-top:6px"><span class="val hl">' +
            d.final_skills +
            " SKUs</span> Â· " +
            d.elapsed_s +
            "s" +
            skuInfo +
            "</div>" +
            skills;
        });
        src.onerror = () => {
          src.close();
          document.getElementById("ptext").textContent = "âŒ è¿æ¥ä¸­æ–­";
        };
      }

      /* â•â•â•â•â•â•â• é¡µé¢æ¢å¤ â•â•â•â•â•â•â• */
      (async function () {
        if (!sessionId) return;
        try {
          const r = await fetch("/api/session/" + sessionId + "/state");
          if (!r.ok) {
            localStorage.removeItem("pdf2skill_session");
            return;
          }
          const st = await r.json();
          showWorkspace(st.meta);
          loadTuneHistory();
          try {
            const pr = await fetch("/api/prompt-preview/" + sessionId);
            if (pr.ok) {
              const pp = await pr.json();
              if (
                pp.baseline_hint &&
                !document.getElementById("prompt-hint").value
              ) {
                document.getElementById("prompt-hint").value = pp.baseline_hint;
              }
              document.getElementById("system-prompt-display").value =
                pp.system_prompt || "";
            }
          } catch (e) {}
        } catch (e) {
          localStorage.removeItem("pdf2skill_session");
        }
      })();
    </script>
  </body>
</html>
